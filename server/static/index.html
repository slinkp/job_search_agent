<!DOCTYPE html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Companies Dashboard</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/@picocss/pico@1/css/pico.min.css"
    />
    <link rel="stylesheet" href="/static/styles.css" />
    <script
      defer
      src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>
    <script src="/static/app.js"></script>
  </head>
  <body>
    <main class="container" x-data="companyList">
      <h1>Companies Dashboard</h1>

      <div x-show="loading">Loading...</div>

      <div class="top-controls">
        <div class="scan-recruiter-emails">
          <div class="input-group">
            <input type="number" value="10" id="maxMessages">
            <button @click="scanRecruiterEmails($el.previousElementSibling.value)" :disabled="scanningEmails">
              <span class="loading-spinner" x-show="scanningEmails"></span>
              Scan Emails
            </button>
          </div>
          <div class="scan-options">
            <label>
              <input type="checkbox" id="doResearch">
              Do research on new recruiter mail
            </label>
          </div>
          <div x-show="emailScanStatus" x-text="getEmailScanStatusText()" :class="getEmailScanStatusClass()"></div>
        </div>

        <div class="list-controls">
          <div class="filter-controls">
            <button @click="filterMode = 'all'" class="filter-button outline" :class="{ 'active': filterMode === 'all' }">
              All
            </button>
            <button @click="filterMode = 'reply-sent'" class="filter-button outline" :class="{ 'active': filterMode === 'reply-sent' }">
              Reply Sent
            </button>
            <button @click="filterMode = 'reply-not-sent'" class="filter-button outline" :class="{ 'active': filterMode === 'reply-not-sent' }">
              No Reply
            </button>
            <button @click="filterMode = 'researched'" class="filter-button outline" :class="{ 'active': filterMode === 'researched' }">
              Researched
            </button>
            <button @click="filterMode = 'not-researched'" class="filter-button outline" :class="{ 'active': filterMode === 'not-researched' }">
              Not Researched
            </button>
          </div>

          <div class="sort-controls">
            <button @click="toggleSort('name')" class="sort-button outline" :class="{ 'active': sortField === 'name' }">
              Name <span x-text="sortField === 'name' ? (sortAsc ? 'â†‘' : 'â†“') : ''"></span>
            </button>
            <button @click="toggleSort('updated_at')" class="sort-button outline" :class="{ 'active': sortField === 'updated_at' }">
              Updated <span x-text="sortField === 'updated_at' ? (sortAsc ? 'â†‘' : 'â†“') : ''"></span>
            </button>
          </div>

          <span class="list-stats" x-text="`${sortedAndFilteredCompanies.length}/${companies.length}`"></span>
        </div>
      </div>

      <template x-for="company in sortedAndFilteredCompanies" :key="company.name">
        <article>
          <header>
            <div class="company-status-icons">
              <span class="status-icon research-done-icon" x-show="company.research_completed_at" title="Research completed">R</span>
              <span class="status-icon research-failed-icon" 
                    x-show="company.research_error || company.research_status === 'failed' || company.research_errors" 
                    title="Research failed">âŒ</span>
              <span class="status-icon reply-sent-icon" x-show="company.sent_at" title="Reply sent">ğŸ“§</span>
              <span class="status-icon archived-icon" x-show="company.sent_at || company.archived_at" title="Archived">A</span>
              <span class="status-icon promising-positive" x-show="company.promising === true" title="Promising">ğŸ‘</span>
              <span class="status-icon promising-negative" x-show="company.promising === false" title="Not promising">ğŸ‘</span>
            </div>
            <a href="#" @click.prevent="document.getElementById(company.name).scrollIntoView({behavior: 'smooth'})" x-text="company.name" :id="company.name"></a>
            updated <span x-text="company.updated_at"></span>
          </header>
          <div class="research-status">
            <button
              @click="research(company)"
              :disabled="isResearching(company)"
              class="research-button"
            >
              <span
                x-text="isResearching(company) ? 'Researching...' : (company.research_completed_at ? 'Redo research' : 'Research!')"
                >Research!</span
              >
              <span
                x-show="isResearching(company)"
                class="loading-spinner"
              ></span>
            </button>
            <span
              x-show="company.research_status"
              x-text="getResearchStatusText(company)"
              :class="getResearchStatusClass(company)"
            >
            </span>
          </div>
          <template x-if="!company.reply_message">
            <button
              @click="generateReply(company)"
              :disabled="isGeneratingMessage(company)"
            >
              <span x-text="isGeneratingMessage(company) ? 'Generating...' : company.reply_message ? 'Regenerate' : 'Generate'"></span>
              <span
                x-show="isGeneratingMessage(company)"
                class="loading-spinner"
              ></span>
            </button>
          </template>
          <template x-if="company.message_status">
            <span
              x-text="getMessageStatusText(company)"
              :class="{'status-pending': company.message_status === 'pending',
                       'status-running': company.message_status === 'running',
                       'status-completed': company.message_status === 'completed',
                       'status-failed': company.message_status === 'failed'}"
            ></span>
          </template>
          <template x-if="company.reply_message">
            <div class="reply-actions">
              <button 
                @click="editReply(company)" 
                :disabled="isGeneratingMessage(company)"
              >Edit reply</button>
              <button 
                @click="generateReply(company)"
                :disabled="isGeneratingMessage(company)"
              >
                <span x-text="isGeneratingMessage(company) ? 'Generating...' : company.reply_message ? 'Regenerate' : 'Generate'"></span>
                <span x-show="isGeneratingMessage(company)" class="loading-spinner"></span>
              </button>
            </div>
          </template>
          <div class="promising-controls" x-show="company.research_completed_at">
            <span>Promising?</span>
            <button 
              @click="togglePromising(company, true)" 
              :class="{ 'active': company.promising === true }" 
              class="btn-small"
              title="Mark as promising"
            >ğŸ‘</button>
            <button 
              @click="togglePromising(company, false)" 
              :class="{ 'active': company.promising === false }" 
              class="btn-small"
              title="Mark as not promising"
            >ğŸ‘</button>
            <button 
              @click="togglePromising(company, null)" 
              :class="{ 'active': company.promising === null || company.promising === undefined }" 
              class="btn-small"
              title="Clear promising status"
            >â“</button>
          </div>
          <details>
            <summary>
              Details...
              <span
                x-text="'(' + Object.keys(company.details || {}).length + ' items)'"
              ></span>
            </summary>
            <div class="company-status-details">
              <div class="status-item">
                <strong>Reply Status:</strong>
                <span x-text="company.sent_at ? 'Replied on ' + new Date(company.sent_at).toLocaleString() : 'Not replied'"></span>
              </div>
              <div class="status-item">
                <strong>Archive Status:</strong>
                <span x-text="company.sent_at || company.archived_at ? 'Archived on ' + new Date(company.archived_at || company.sent_at).toLocaleString() : 'Not archived'"></span>
              </div>
              <div class="status-item">
                <strong>Research Status:</strong>
                <span x-text="company.research_completed_at ? 'Completed on ' + new Date(company.research_completed_at).toLocaleString() : 'Not fully researched'"></span>
              </div>
              <div class="status-item">
                <strong>Promising:</strong>
                <span x-text="company.promising === true ? 'Yes' : (company.promising === false ? 'No' : 'Not evaluated')"></span>
              </div>
              <div class="status-item" x-show="company.research_errors">
                <strong>Research Errors:</strong>
                <span x-text="formatResearchErrors(company)" class="research-error-text"></span>
              </div>
            </div>
            <p>
              <template
                x-for="[key, value] in Object.entries(company.details || {})"
                :key="key"
              >
                <template x-if="value">
                  <span>
                    <span x-text="key + ': '"></span>
                    <template x-if="isUrl(value)">
                      <a :href="value" x-text="value"></a>
                    </template>
                    <template x-if="!isUrl(value)">
                      <span x-text="value"></span>
                    </template>
                    <br />
                  </span>
                </template>
              </template>
            </p>
          </details>
        </article>
      </template>

      <!-- Modal for editing replies -->
      <dialog id="editModal" x-show="editingCompany" x-cloak>
        <article>
          <header>
            <div class="modal-header-content">
              <h3>Edit Reply</h3>
              <div class="company-status-icons modal-status-icons" x-show="editingCompany">
                <span class="status-icon research-done-icon" x-show="editingCompany?.research_completed_at" title="Research completed">R</span>
                <span class="status-icon research-failed-icon" 
                      x-show="editingCompany?.research_error || editingCompany?.research_status === 'failed' || editingCompany?.research_errors" 
                      title="Research failed">âŒ</span>
                <span class="status-icon reply-sent-icon" x-show="editingCompany?.sent_at" title="Reply sent">ğŸ“§</span>
                <span class="status-icon archived-icon" x-show="editingCompany?.sent_at || editingCompany?.archived_at" title="Archived">A</span>
                <span class="status-icon promising-positive" x-show="editingCompany?.promising === true" title="Promising">ğŸ‘</span>
                <span class="status-icon promising-negative" x-show="editingCompany?.promising === false" title="Not promising">ğŸ‘</span>
              </div>
            </div>
          </header>
          <form @submit.prevent="saveReply">
            <div class="modal-promising-controls" x-show="editingCompany?.research_completed_at">
              <span>Promising?</span>
              <button 
                type="button"
                @click="togglePromising(editingCompany, true)" 
                :class="{ 'active': editingCompany?.promising === true }" 
                class="btn-small"
                title="Mark as promising"
              >ğŸ‘</button>
              <button 
                type="button"
                @click="togglePromising(editingCompany, false)" 
                :class="{ 'active': editingCompany?.promising === false }" 
                class="btn-small"
                title="Mark as not promising"
              >ğŸ‘</button>
              <button 
                type="button"
                @click="togglePromising(editingCompany, null)" 
                :class="{ 'active': editingCompany?.promising === null || editingCompany?.promising === undefined }" 
                class="btn-small"
                title="Clear promising status"
              >â“</button>
            </div>
            <textarea x-model="editingReply" rows="5"></textarea>
            <footer>
              <button type="button" @click="cancelEdit" :disabled="isGeneratingMessage(editingCompany)">Cancel</button>
              <button type="submit" :disabled="isGeneratingMessage(editingCompany)">Save</button>
              <button 
                type="button" 
                @click="generateReply(editingCompany, true)"
                :disabled="isGeneratingMessage(editingCompany)"
              >
                <span x-text="isGeneratingMessage(editingCompany) ? 'Generating...' : 'Regenerate reply'"></span>
                <span x-show="isGeneratingMessage(editingCompany)" class="loading-spinner"></span>
              </button>
              <button 
                type="button" 
                @click="ignoreAndArchive(editingCompany)"
                :disabled="isGeneratingMessage(editingCompany)"
                class="secondary"
              >
                Ignore & Archive
              </button>
              <button 
                type="button" 
                @click="sendAndArchive(editingCompany)"
                :disabled="isGeneratingMessage(editingCompany) || !editingCompany?.reply_message"
                class="primary"
              >
                Send & Archive
              </button>
            </footer>
          </form>
          <div class="original-message" x-show="editingCompany?.recruiter_message?.message">
            <h4>
              Original Message
            </h4>
            <div class="message-headers">
              <p><strong>Subject:</strong> <span x-text="editingCompany?.recruiter_message?.subject"></span></p>
              <p><strong>From:</strong> <span x-text="editingCompany?.recruiter_message?.sender"></span></p>
              <p><strong>Date:</strong> <span x-text="formatRecruiterMessageDate(editingCompany?.recruiter_message?.date)"></span></p>
              <p x-show="editingCompany?.recruiter_message?.email_thread_link">
                <strong>Thread:</strong> 
                <a :href="editingCompany?.recruiter_message?.email_thread_link" target="_blank">View in Gmail</a>
              </p>
            </div>
            <pre x-text="editingCompany?.recruiter_message?.message"></pre>
          </div>
          <div class="status-item" x-show="editingCompany?.research_errors">
            <strong>Research Errors:</strong>
            <span x-text="formatResearchErrors(editingCompany)" class="research-error-text"></span>
          </div>
        </article>
      </dialog>
    </main>
  </body>
</html>
